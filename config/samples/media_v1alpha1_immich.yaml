apiVersion: media.rm3l.org/v1alpha1
kind: Immich
metadata:
  labels:
    app.kubernetes.io/name: immich-operator
    app.kubernetes.io/managed-by: kustomize
  name: immich-sample
spec:
  # Image pull secrets for private registries (optional)
  # imagePullSecrets:
  #   - name: my-registry-secret

  # Immich shared configuration
  immich:
    # Enable Prometheus metrics
    metrics:
      enabled: false

    # Persistence configuration for photo library
    persistence:
      library:
        # Option 1: Let the operator create and manage the PVC
        size: 100Gi
        # storageClass: my-storage-class  # optional
        # accessModes: ["ReadWriteOnce"]  # optional
        
        # Option 2: Use an existing PVC (comment out size above and uncomment below)
        # existingClaim: my-existing-pvc

    # Immich configuration file (converted to YAML)
    # ref: https://immich.app/docs/install/config-file/
    configuration:
      trash:
        enabled: true
        days: 30
      storageTemplate:
        enabled: true
        template: "{{y}}/{{y}}-{{MM}}-{{dd}}/{{filename}}"

    # Store configuration in ConfigMap (or "Secret" for sensitive data)
    configurationKind: ConfigMap

  # PostgreSQL database configuration (built-in by default)
  postgres:
    # Built-in PostgreSQL is enabled by default
    enabled: true
    # Image is optional - defaults to RELATED_IMAGE_postgres env var
    # image: ghcr.io/immich-app/postgres:14-vectorchord0.4.3-pgvectors0.2.0
    # Persistence configuration
    persistence:
      size: 10Gi
      # storageClass: standard
    # Password is auto-generated if not provided
    # To use your own password, uncomment:
    # passwordSecretRef:
    #   name: my-postgres-secret
    #   key: password
    # resources:
    #   requests:
    #     cpu: 100m
    #     memory: 256Mi

    # --- To use an external PostgreSQL instead, set enabled: false ---
    # enabled: false
    # host: postgres.database.svc.cluster.local
    # port: 5432
    # database: immich
    # username: immich
    # passwordSecretRef:
    #   name: external-postgres-secret
    #   key: password

  # Server component configuration
  server:
    enabled: true
    replicas: 1
    # Image is optional - defaults to RELATED_IMAGE_immich env var
    # image: ghcr.io/immich-app/immich-server:v2.4.1
    # imagePullPolicy: IfNotPresent
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        memory: 2Gi
    ingress:
      enabled: true
      ingressClassName: nginx
      annotations:
        nginx.ingress.kubernetes.io/proxy-body-size: "0"
      hosts:
        - host: immich.example.com
          paths:
            - path: /
              pathType: Prefix
      tls:
        - hosts:
            - immich.example.com
          secretName: immich-tls

  # Machine Learning component configuration (built-in by default)
  machineLearning:
    # Built-in ML is enabled by default
    enabled: true
    replicas: 1
    # Image is optional - defaults to RELATED_IMAGE_machineLearning env var
    # image: ghcr.io/immich-app/immich-machine-learning:v2.4.1
    # imagePullPolicy: IfNotPresent
    resources:
      requests:
        cpu: 100m
        memory: 512Mi
      limits:
        memory: 4Gi
    persistence:
      enabled: true
      size: 10Gi
      # storageClass: standard

    # --- To disable ML completely (no smart search, face detection, etc.) ---
    # enabled: false

    # --- To use an external ML service instead ---
    # enabled: false
    # url: http://external-ml-service:3003

  # Valkey (Redis) component configuration (built-in by default)
  valkey:
    # Built-in Valkey is enabled by default
    enabled: true
    # Image is optional - defaults to RELATED_IMAGE_valkey env var
    # image: docker.io/valkey/valkey:9-alpine
    # imagePullPolicy: IfNotPresent
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        memory: 256Mi
    persistence:
      enabled: false  # Set to true for persistent job queues
      size: 5Gi

    # --- To use an external Redis/Valkey instead, set enabled: false ---
    # enabled: false
    # host: redis.external.svc.cluster.local
    # port: 6379
    # passwordSecretRef:
    #   name: external-redis-secret
    #   key: password
    # dbIndex: 0
